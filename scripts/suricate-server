#!/usr/bin/env python
from __future__ import print_function

import os
import sys
import fcntl
from subprocess import check_output, STDOUT
import requests
from suricate import server
from argparse import ArgumentParser


parser = ArgumentParser(description='http://suricate.readthedocs.org/')
parser.add_argument('--no_components', action='store_true')
parser.add_argument('action', choices=['start', 'stop'])

args = parser.parse_args()

try:
    confdir = os.path.join(os.getenv('HOME'), '.suricate')
    sys.path.insert(0, confdir)
    from config import COMPONENTS
except ImportError, ex:
    print('ERROR: %s.' % ex)
    print('Please run the suricate-config command in order to')
    print('create the %s/config.py file.' % confdir)
    sys.exit(1)
finally:
    sys.path.remove(confdir)

PORT = 5000
BASEURL = 'http://127.0.0.1:%d' % PORT
if args.action == 'start':
    # Check if ACS is ready
    output = check_output(['acsStatus'], stderr=STDOUT)
    if 'Unable to determine manager' in output:
        print('ERROR: ACS is not running')
        sys.exit(1)
    if args.no_components:
        server.start()
    else:
        server.start(COMPONENTS)
elif args.action == 'stop':
    url = BASEURL + '/publisher/api/v0.1/stop'
    msg = ''
    try:
        requests.post(url)
        print('A "stop" request has been sent to the server')
    except requests.exceptions.ConnectionError:
        print('The server was already stopped...')
